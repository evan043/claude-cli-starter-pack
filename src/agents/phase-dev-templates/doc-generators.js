/**
 * Documentation generators for phased development plans.
 * Generates markdown documentation files from plan configuration.
 */

import { SCALE_DEFINITIONS } from './index.js';

/**
 * Generate stack table from architecture config
 */
function generateStackTable(architecture) {
  if (!architecture) return '- Not specified';

  const rows = [];

  if (architecture.frontend) {
    const fe = architecture.frontend;
    rows.push(`- **Frontend:** ${fe.framework}${fe.language === 'typescript' ? ' + TypeScript' : ''}${fe.bundler ? ` + ${fe.bundler}` : ''}`);
  }

  if (architecture.backend) {
    const be = architecture.backend;
    rows.push(`- **Backend:** ${be.framework} (${be.language})`);
  }

  if (architecture.database) {
    const db = architecture.database;
    rows.push(`- **Database:** ${db.type}${db.orm ? ` + ${db.orm}` : ''}`);
  }

  if (architecture.deployment) {
    rows.push(`- **Deployment:** ${architecture.deployment.platform}`);
  }

  return rows.length > 0 ? rows.join('\n') : '- Not specified';
}

/**
 * Generate EXECUTIVE_SUMMARY.md
 */
export function generateExecutiveSummary(config) {
  const {
    projectName,
    projectSlug,
    description,
    scale,
    phases,
    scope,
    architecture,
  } = config;

  const scaleInfo = SCALE_DEFINITIONS[scale];
  const totalTasks = phases.reduce((sum, p) => sum + p.tasks.length, 0);

  const phaseList = phases
    .map(
      (p, i) => `
### Phase ${i + 1}: ${p.name}

**Description:** ${p.description}

**Tasks:** ${p.tasks.length}

**Key Deliverables:**
${p.tasks.slice(0, 5).map((t) => `- ${t.title}`).join('\n')}${p.tasks.length > 5 ? `\n- ... and ${p.tasks.length - 5} more` : ''}

**Validation Criteria:**
${(p.validationCriteria || ['All tasks complete', 'Tests pass']).map((c) => `- ${c}`).join('\n')}
`
    )
    .join('\n');

  return `# ${projectName} - Executive Summary

## Project Overview

**Slug:** \`${projectSlug}\`
**Scale:** ${scaleInfo.name} (${scale})
**Phases:** ${phases.length}
**Total Tasks:** ${totalTasks}
**Success Probability:** 95%+

## Description

${description}

## Scope Assessment

| Metric | Value |
|--------|-------|
| Lines of Code | ${scope?.linesOfCode || 'TBD'} |
| Components | ${scope?.components || 'TBD'} |
| Integrations | ${scope?.integrations || 'TBD'} |
| Familiarity | ${scope?.familiarity || 'TBD'} |

## Architecture

${architecture?.summary || 'See detected stack below.'}

### Technology Stack

${generateStackTable(architecture)}

## Phase Breakdown

${phaseList}

## Execution

### Start Development

\`\`\`bash
# Run the interactive command
/phase-dev-${projectSlug}

# Or execute Phase 1
/phase-dev-${projectSlug} 1
\`\`\`

### Monitor Progress

\`\`\`bash
# Check current status
cat .claude/docs/${projectSlug}/PROGRESS.json | jq '.phases[] | {name, status}'
\`\`\`

## Success Criteria

- [ ] All phases completed
- [ ] Tests pass
- [ ] No build errors
- [ ] Documentation updated

---

*Generated by gtask create-phase-dev - ${new Date().toISOString()}*
`;
}

/**
 * Generate MIDDLEWARE_SPEC.md (generic)
 */
export function generateMiddlewareSpec(config) {
  const { projectName, projectSlug, architecture = {} } = config;

  const backend = architecture.backend;
  const backendInfo = backend
    ? `${backend.framework} (${backend.language})`
    : 'Not specified';

  return `# ${projectName} - Middleware Specification

## Overview

**Backend Framework:** ${backendInfo}

## Middleware Stack

Configure your middleware based on your framework:

### 1. Request Logging

Track all incoming requests for debugging and analytics.

\`\`\`
# Add your logging middleware here
\`\`\`

### 2. Authentication

Verify user identity and permissions.

\`\`\`
# JWT validation, session handling, etc.
\`\`\`

### 3. Rate Limiting

Protect against abuse and ensure fair usage.

\`\`\`
# Configure rate limits based on your needs
\`\`\`

### 4. CORS Configuration

Control cross-origin access.

\`\`\`
# Configure allowed origins
\`\`\`

### 5. Error Handling

Consistent error response formatting.

\`\`\`
# Global error handler
\`\`\`

### 6. Validation

Request body and parameter validation.

\`\`\`
# Schema validation middleware
\`\`\`

## Middleware Order

Execute middleware in this order for best results:

1. Request logging (first - captures all requests)
2. CORS (early - reject invalid origins fast)
3. Rate limiting (early - prevent abuse)
4. Authentication (verify identity)
5. Validation (validate request data)
6. Route handlers (business logic)
7. Error handling (last - catch all errors)

## Framework-Specific Notes

*Add notes specific to your backend framework here*

---

*Reference: .claude/docs/${projectSlug}/MIDDLEWARE_SPEC.md*
`;
}

/**
 * Generate API_ENDPOINTS.md (generic)
 */
export function generateApiEndpoints(config) {
  const { projectName, projectSlug, architecture = {} } = config;

  const backend = architecture.backend;
  const backendInfo = backend
    ? `${backend.framework} (${backend.language})`
    : 'Not specified';

  return `# ${projectName} - API Endpoints

## Overview

**Backend Framework:** ${backendInfo}

## Base URL

Configure your base URL in environment variables:

\`\`\`
# Development
API_URL=http://localhost:3000/api

# Production
API_URL=https://your-domain.com/api
\`\`\`

## Authentication

Define your authentication strategy here:

- JWT Bearer tokens
- API keys
- Session-based auth
- OAuth 2.0

## Endpoints

*Define your endpoints here as you build them:*

### Example Endpoint

\`\`\`
GET /api/health
\`\`\`

**Response:**
\`\`\`json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00Z"
}
\`\`\`

## Error Responses

All errors should follow a consistent structure:

\`\`\`json
{
  "error": true,
  "code": "ERROR_CODE",
  "message": "Human-readable message",
  "details": {}
}
\`\`\`

---

*Reference: .claude/docs/${projectSlug}/API_ENDPOINTS.md*
`;
}

/**
 * Generate DATABASE_SCHEMA.md (generic)
 */
export function generateDatabaseSchema(config) {
  const { projectName, projectSlug, architecture = {} } = config;

  const database = architecture.database;
  const dbType = database?.type || 'Not specified';
  const orm = database?.orm || 'Not specified';

  return `# ${projectName} - Database Schema

## Overview

**Database:** ${dbType}
**ORM/Driver:** ${orm}

## Configuration

Set your database connection in environment variables:

\`\`\`
DATABASE_URL=your-connection-string-here
\`\`\`

## Tables / Collections

*Define your schema here as you build it:*

### Example Table

| Column | Type | Constraints |
|--------|------|-------------|
| id | UUID/ObjectId | PRIMARY KEY |
| created_at | TIMESTAMP | DEFAULT NOW() |
| updated_at | TIMESTAMP | DEFAULT NOW() |

## Migrations

Document your migration strategy:

- Migration tool: (Prisma/TypeORM/Alembic/etc.)
- Migration location: \`/migrations\` or \`/prisma\`

## Indexes

*List important indexes for query optimization*

## Relationships

*Document entity relationships*

---

*Reference: .claude/docs/${projectSlug}/DATABASE_SCHEMA.md*
`;
}

/**
 * Generate DEPLOYMENT_CONFIG.md (generic)
 */
export function generateDeploymentConfig(config) {
  const { projectName, projectSlug, architecture = {} } = config;

  const deployment = architecture.deployment;
  const platform = deployment?.platform || 'Not specified';

  return `# ${projectName} - Deployment Configuration

## Platform

**Target Platform:** ${platform}

## Environment Variables

### Required Variables

\`\`\`
# Add your required environment variables here
NODE_ENV=production
DATABASE_URL=
API_URL=
\`\`\`

### Optional Variables

\`\`\`
# Add optional configuration here
LOG_LEVEL=info
ENABLE_ANALYTICS=true
\`\`\`

## Deployment Steps

1. Build the application
2. Run database migrations
3. Deploy to ${platform}
4. Verify health checks
5. Update DNS if needed

## Deployment Commands

*Add your deployment commands here:*

\`\`\`bash
# Example build command
npm run build

# Example deploy command
# Your platform-specific deploy command here
\`\`\`

## Rollback Procedure

1. Identify the issue
2. Revert to previous deployment
3. Investigate root cause
4. Deploy fix

## Monitoring

- Health check endpoint: \`/api/health\`
- Logs: Configure your logging service
- Alerts: Set up monitoring for critical metrics

---

*Reference: .claude/docs/${projectSlug}/DEPLOYMENT_CONFIG.md*
`;
}
