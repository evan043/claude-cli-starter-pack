# Canary Release Pipeline
# Publishes feature branches to npm with @next or @canary tag for testing
# Useful for testing changes before merging to main

name: Canary Release

on:
  # Manual trigger for any branch
  workflow_dispatch:
    inputs:
      tag:
        description: 'npm dist-tag (next, canary, beta, alpha)'
        required: false
        default: 'next'
        type: choice
        options:
          - next
          - canary
          - beta
          - alpha
      dry_run:
        description: 'Dry run (do not publish)'
        required: false
        default: false
        type: boolean

  # Auto-publish worktree branches with naming convention
  push:
    branches:
      - 'ccasp-*'      # Worktree branches created by dev-deploy
      - 'feature/*'    # Feature branches
      - 'canary/*'     # Explicit canary branches

# Prevent concurrent canary releases
concurrency:
  group: canary-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Validate branch and determine tag
  # ============================================
  prepare:
    name: Prepare Canary Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.canary }}
      tag: ${{ steps.tag.outputs.value }}
      should_publish: ${{ steps.check.outputs.publish }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine npm tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
            case "$BRANCH" in
              canary/*) TAG="canary" ;;
              feature/*) TAG="next" ;;
              ccasp-*) TAG="next" ;;
              *) TAG="next" ;;
            esac
          fi
          echo "value=$TAG" >> $GITHUB_OUTPUT
          echo "Using npm tag: $TAG"

      - name: Generate canary version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BRANCH_SLUG=$(echo "${GITHUB_REF#refs/heads/}" | sed 's/[^a-zA-Z0-9]/-/g' | cut -c1-20)

          # Format: 1.8.25-next.20240115123456.abc1234
          CANARY_VERSION="${BASE_VERSION}-${{ steps.tag.outputs.value }}.${TIMESTAMP}.${SHORT_SHA}"

          echo "canary=$CANARY_VERSION" >> $GITHUB_OUTPUT
          echo "Canary version: $CANARY_VERSION"

      - name: Check if should publish
        id: check
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "publish=false" >> $GITHUB_OUTPUT
            echo "Dry run - will not publish"
          else
            echo "publish=true" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Run tests before canary release
  # ============================================
  test:
    name: Pre-Canary Tests
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Verify CLI
        run: node bin/gtask.js --version

  # ============================================
  # Publish canary to npm
  # ============================================
  publish-canary:
    name: Publish Canary
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: needs.prepare.outputs.should_publish == 'true'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Update version for canary
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version
          echo "Updated package.json to version ${{ needs.prepare.outputs.version }}"

      - name: Publish to npm with tag
        run: |
          npm publish --tag ${{ needs.prepare.outputs.tag }} --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        run: |
          echo "## ğŸ¤ Canary Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.prepare.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install -g claude-cli-advanced-starter-pack@${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "# or specific version:" >> $GITHUB_STEP_SUMMARY
          echo "npm install -g claude-cli-advanced-starter-pack@${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Dry run output
  # ============================================
  dry-run-summary:
    name: Dry Run Summary
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: needs.prepare.outputs.should_publish == 'false'
    steps:
      - name: Summary
        run: |
          echo "## ğŸ§ª Canary Dry Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Would publish version:** \`${{ needs.prepare.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**With tag:** \`${{ needs.prepare.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes were made. Run without dry_run to publish." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Comment on PR if triggered from PR branch
  # ============================================
  comment-on-pr:
    name: Comment on Related PR
    runs-on: ubuntu-latest
    needs: [prepare, publish-canary]
    if: needs.prepare.outputs.should_publish == 'true'
    permissions:
      pull-requests: write
    steps:
      - name: Find related PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Comment on PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const version = '${{ needs.prepare.outputs.version }}';
            const tag = '${{ needs.prepare.outputs.tag }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ğŸ¤ Canary Release Available

            A canary version of this PR has been published to npm for testing.

            \`\`\`bash
            npm install -g claude-cli-advanced-starter-pack@${tag}
            # or
            npm install -g claude-cli-advanced-starter-pack@${version}
            \`\`\`

            This version will be available until the next canary release overwrites it.

            ---
            *Automated canary release from workflow*`
            });
